# Мультиагентная система разработки ПО

## Общая концепция

Система состоит из команды специализированных агентов, координируемых оркестратором. Каждый агент выполняет определённую роль в процессе разработки. Оркестратор управляет последовательностью работы, передаёт результаты между агентами и останавливает процесс при возникновении блокирующих вопросов.

## Роли агентов

### 1. Оркестратор
**Функция:** Координация всего процесса разработки
- Ставит задачи другим агентам
- Принимает и анализирует результаты
- Определяет следующие шаги
- Останавливает процесс при блокирующих вопросах
- Управляет циклами review-доработка

### 2. Аналитик
**Функция:** Создание технического задания
- Принимает высокоуровневую постановку задачи
- Создаёт ТЗ со списком юзер-кейсов
- Описывает сценарии (основной и альтернативные)
- Определяет актёров для каждого юзер-кейса
- Формулирует критерии приёмки
- **НЕ пишет код**

### 3. Ревьюер ТЗ
**Функция:** Проверка качества технического задания
- Оценивает полноту описания задачи
- Проверяет соответствие существующему проекту
- Выявляет противоречия и пробелы

### 4. Архитектор
**Функция:** Проектирование архитектуры системы
- Разрабатывает функциональную архитектуру (компоненты и их функции)
- Проектирует системную архитектуру (разделение на компоненты)
- Описывает интерфейсы (внешние и внутренние)
- Проектирует модель данных
- Определяет стек технологий
- Даёт рекомендации по развёртыванию
- **НЕ пишет код**

### 5. Ревьюер архитектуры
**Функция:** Проверка качества архитектуры
- Оценивает соответствие архитектуры ТЗ и постановке задачи
- Проверяет совместимость с существующей архитектурой проекта
- Выявляет архитектурные противоречия

### 6. Техлид-планировщик
**Функция:** Формулировка задач для разработки
- Создаёт низкоуровневый план с задачами
- Связывает задачи с юзер-кейсами
- Определяет последовательность выполнения задач
- Создаёт детальные описания задач в отдельных файлах
- Указывает конкретные места для внесения изменений в коде
- Указывает список тест-кейсов для каждой задачи
- Формулирует задачи на тесты и развёртывание
- **НЕ пишет код** (только названия классов, методов, параметры)

### 7. Ревьюер плана
**Функция:** Проверка качества плана
- Проверяет покрытие всех юзер-кейсов из ТЗ
- Проверяет наличие детальных описаний для всех задач
- **НЕ вникает глубоко в содержимое описаний**

### 8. Разработчик
**Функция:** Реализация задач и написание тестов
- Выполняет задачи строго по описанию планировщика
- Пишет структурированный, документированный код
- Следует лучшим практикам разработки
- Избегает дублирования кода
- Пишет автотесты (включая end-to-end)
- Запускает тесты (новые и регресс)
- Актуализирует документацию проекта
- Создаёт описания для каждого каталога
- Предоставляет отчёт о выполненных тестах
- Исправляет замечания от ревьюера
- **НЕ рефакторит код без явного указания**

### 9. Ревьюер кода
**Функция:** Проверка качества кода
- Проверяет соответствие кода постановке задачи
- Отслеживает непротиворечивость с существующим функционалом
- Проверяет прохождение end-to-end тестов
- Проверяет замену заглушек на реальный код
- Анализирует отчёт о тестировании

## Принципы работы системы

### Подход "Stub-First & E2E"
Система реализуется строго в два этапа для каждого компонента:
1. **Stubbing (Заглушки):** Создание полной структуры и заглушек + E2E тест на хардкоде.
2. **Implementation (Реализация):** Замена заглушек на реальную логику + обновление тестов.

### Протоколы защиты и качества
- **Anti-Loop:** Если тесты падают 2 раза с одной ошибкой — СТОП и анализ.
- **Documentation First:** Обязательное создание `.AGENTS.md` в каждой папке.
- **Reconnaissance:** Анализ контекста перед началом работы (чтение `.AGENTS.md`).

### Управление неопределённостью
- **Аналитик:** Максимальное внимание к неясным моментам
- **Архитектор:** Много внимания к открытым вопросам
- **Планировщик:** Меньше вопросов, но при нестыковках — обязательно
- **Разработчик:** Стремится выполнить по описанию, но может задавать вопросы

### Работа с открытыми вопросами
Любой агент при возникновении сложностей:
1. Добавляет вопросы в файл открытых вопросов
2. Возвращает список вопросов оркестратору
3. Оркестратор останавливает работу
4. Ожидается ответ пользователя

## WORKFLOWS (Dynamic Dispatch)
The system supports multiple development "variants" via workspace workflows.
- **Source of Truth**: `.agent/workflows/`
- **Dynamic Dispatch**: If a user request matches a workflow file (e.g., `vdd-03-develop.md`), the Orchestrator MUST execute that workflow instead of the standard process described below.

## Процесс разработки

### Этап 1: Анализ
```
Пользователь  →  Оркестратор (формулировка задачи + описание проекта)
                                ↓
        [РЕШЕНИЕ: Новая задача? → Архив docs/TZ.md]
                                ↓
                            Аналитик → ТЗ
                                ↓
                         Ревьюер ТЗ → Замечания
                                ↓
                         Аналитик (доработка)
                                ↓
                         Ревьюер ТЗ (повторно)
```
**Циклы:** Максимум 2 итерации review

**Блокировка:** При критичных замечаниях после 2-го review

### Этап 2: Проектирование архитектуры
```
ТЗ + Описание проекта → Архитектор → Архитектура
                            ↓
                     Ревьюер архитектуры → Замечания
                            ↓
                     Архитектор (доработка)
                            ↓
                     Ревьюер архитектуры (повторно)
```
**Циклы:** Максимум 2 итерации review

**Блокировка:** При критичных замечаниях после 2-го review

### Этап 3: Планирование
```
ТЗ + Архитектура + Описание проекта + код → Планировщик → План + Описания задач
                                                ↓
                                          Ревьюер плана → Замечания
                                                ↓
                                          Планировщик (доработка)
                                                ↓
                                          Ревьюер плана (повторно)
```
**Циклы:** 1 итерация доработки (всего 2 review)

**Блокировка:** При критичных замечаниях после 2-го review

### Этап 4: Выполнение задач
```
Для каждой задачи из плана:
    Описание задачи → Разработчик → Код + Тесты + Отчёт
                           ↓
                     Ревьюер кода → Замечания
                           ↓
                     Разработчик (исправление)
                           ↓
                     Ревьюер кода (повторно)
```
**Циклы:** 1 итерация исправлений (всего 2 review)

## Документация проекта

### Структура документации
1. **Общее описание проекта** (отдельно для людей и для агентов)
2. **Описание каждого каталога:**
   - Список файлов
   - Список функций
   - Краткое описание функциональности
3. **Частные детальные документы** (при большом объёме, на них ссылки в общем описании)

### Актуализация
Разработчик обязан актуализировать документацию при каждом изменении кода.

## Ключевые правила

### Для всех агентов
- ❌ Не выходить за рамки своей роли
- ❌ Не рефакторить без явного указания
- ✅ Задавать вопросы при неясностях
- ✅ Документировать свою работу

### Для оркестратора
- Строго следовать количеству циклов review
- Останавливать процесс при блокирующих вопросах
- Передавать полный контекст между агентами

### Для разработчика
- Точно следовать описанию задачи
- Запускать все тесты (новые + регресс)
- Предоставлять отчёт о тестировании
- Исправлять только указанные замечания

### ГЛОБАЛЬНЫЕ ПРАВИЛА РАБОТЫ С АРТЕФАКТАМИ
РАБОТА С АРТЕФАКТАМИ: ТЕХНИЧЕСКОЕ ЗАДАНИЕ (TZ.md)

СТРОГИЕ ПРАВИЛА (обязательны для всех агентов):
- docs/TZ.md содержит спецификацию ТОЛЬКО для ОДНОЙ ТЕКУЩЕЙ активной задачи.
- Различай фазы задачи:
  - "Уточнение/доработка/итерация" = изменения внутри ТОЙ ЖЕ задачи (например, "улучши ТЗ", "добавь детали", "исправь противоречия").
    → Перезаписывай docs/TZ.md полностью. НЕ архивируй. Сохраняй как единый эволюционирующий документ для текущей задачи.
  - "Новая задача" = явно другая фича/багфикс/рефакторинг (например, пользователь говорит "теперь реализуй платежи", "начать новый модуль", "следующая фича").
    → Сначала архивируй текущий TZ.md (если в нем есть значимый контент), затем перезапиши новым.
- При начале НОВОЙ задачи:
  - Если docs/TZ.md содержит предыдущий контент → сначала архивируй его.
  - Затем ПЕРЕЗАПИШИ docs/TZ.md полностью новой спецификацией.
  - НИКОГДА не добавляй (append) к существующему контенту.
- Триггеры архивации (строго):
  - ТОЛЬКО после полного завершения задачи (после реализации, тестов и перед финальным коммитом).
  - ИЛИ явно перед началом НОВОЙ задачи (когда ввод пользователя явно указывает на новую отдельную задачу).
  - НЕ архивируй на ранних стадиях (итерации анализа, review ТЗ, уточнения).
- Процедура архивации (когда сработал триггер):
  1. **Определение имени файла:**
     - Сначала прочитай содержимое `docs/TZ.md`.
     - Найди раздел "Meta Information" (Task ID и Slug).
     - **ЕСЛИ НАЙДЕНО:** Используй `docs/tasks/task-{ID}-{Slug}.md`.
     - **ЕСЛИ НЕ НАЙДЕНО:**
       - Определи ID: Проверь существующие файлы в `docs/tasks/`, используй следующий номер с нулями (001, 002, ...).
       - Slug: Сформируй из названия задачи (kebab-case, макс 30 символов, без пробелов).
       - Имя файла: `docs/tasks/task-{GeneratedID}-{DerivedSlug}.md`.
  2. Создай файл с ПОЛНЫМ содержимым текущего docs/TZ.md.
  3. Добавь заголовок в начало: # Archived Task: <Полное имя задачи> — Archived on: YYYY-MM-DD
  4. Если папки docs/tasks/ не существует — создай её.
  5. Подтверди архивацию в ответе (например, "Архивировал предыдущее ТЗ в docs/tasks/task-003-loyalty-system.md").
- После архивации: Продолжай с новым ТЗ (перезаписывай полностью).
